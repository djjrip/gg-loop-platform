<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ AI Options Advisor - Guaranteed Opportunities</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(to right, #10b981, #38bdf8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .live-banner {
            background: linear-gradient(135deg, #059669, #10b981);
            border: 2px solid #4ade80;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .warning {
            background: linear-gradient(135deg, #7c2d12, #991b1b);
            border: 2px solid #f87171;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .input-section {
            background: #1e293b;
            border: 2px solid #334155;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #e0f2fe;
            font-size: 1rem;
            font-weight: 600;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            color: #f8fafc;
            font-size: 1rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: #10b981;
            outline: none;
        }

        .help-text {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        .scan-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #10b981, #3b82f6);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .scan-button:hover {
            transform: scale(1.02);
        }

        .scan-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .loading-bar {
            width: 100%;
            height: 6px;
            background: #1e293b;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #38bdf8);
            transition: width 0.3s;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .loading-text {
            color: #94a3b8;
            font-size: 0.95rem;
            text-align: center;
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .results-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .results-header h2 {
            color: #10b981;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .results-header p {
            color: #94a3b8;
            font-size: 1rem;
        }

        .trade-card {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 3px solid;
            position: relative;
        }

        .trade-card.call {
            border-color: #10b981;
        }

        .trade-card.put {
            border-color: #ef4444;
        }

        .rank-badge {
            position: absolute;
            top: -15px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #0f172a;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .confidence-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            border: 2px solid;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .confidence-high {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #4ade80;
            color: white;
        }

        .confidence-medium {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #60a5fa;
            color: white;
        }

        .confidence-low {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-color: #fbbf24;
            color: white;
        }

        .trade-header {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .trade-header.call {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .trade-header.put {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .trade-header h3 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .trade-header p {
            font-size: 1.2rem;
        }

        .trade-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .meta-item {
            background: #1e3a5f;
            padding: 12px;
            border-radius: 8px;
        }

        .meta-label {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .meta-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #f8fafc;
        }

        .contract-details {
            background: #1e3a5f;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #334155;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #94a3b8;
        }

        .detail-value {
            font-weight: bold;
            color: #10b981;
        }

        .profit-section {
            background: linear-gradient(135deg, #10b981, #3b82f6);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .profit-section h4 {
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .profit-section .profit-amount {
            font-size: 3rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .profit-section .roi {
            font-size: 1.3rem;
            color: #e0f2fe;
        }

        .risk-score {
            background: #0a1929;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .risk-score-bar {
            width: 100%;
            height: 20px;
            background: #1e293b;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .risk-score-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #fbbf24, #10b981);
            transition: width 0.5s;
        }

        .instructions {
            background: #1e3a5f;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .instructions h4 {
            color: #38bdf8;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .step {
            background: #0a1929;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            color: #e0f2fe;
        }

        .step-number {
            display: inline-block;
            background: #10b981;
            color: #0f172a;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            margin-right: 10px;
        }

        .budget-tag {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ AI Options Advisor</h1>
        <p class="subtitle">Guaranteed Opportunities ‚Ä¢ Real Data ‚Ä¢ Any Budget</p>

        <div class="live-banner">
            üü¢ LIVE MODE - Always Finding Opportunities
        </div>

        <div class="warning">
            ‚ö†Ô∏è <strong>Risk Warning:</strong> Options trading is extremely risky. You can lose 100% of your investment. This tool provides data-driven analysis but NO GUARANTEES. You are responsible for your own trades.
        </div>

        <div class="input-section">
            <div class="input-group">
                <label>üíµ Your Budget</label>
                <input type="number" id="budget" value="500" min="1" step="0.01" placeholder="Enter any amount">
                <p class="help-text">Enter ANY amount - we ALWAYS find opportunities (even $1!)</p>
            </div>

            <div class="input-group">
                <label>‚è±Ô∏è Expiration Time</label>
                <select id="dte">
                    <option value="7">1 Week (Aggressive)</option>
                    <option value="14">2 Weeks (Balanced)</option>
                    <option value="30" selected>1 Month (Conservative)</option>
                </select>
                <p class="help-text">Longer = More time for the trade to work</p>
            </div>

            <button class="scan-button" id="scanBtn" onclick="scanMarket()">
                üöÄ Find My Best 3 Opportunities
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="loading-bar">
                <div class="loading-progress" id="progressBar"></div>
            </div>
            <p class="loading-text" id="loadingText">Preparing scan...</p>
        </div>

        <div class="results" id="results"></div>
    </div>

    <script>
        // ==================== CONFIG ====================
        const FINNHUB_KEY = 'd4mals9r01qjidhukr8gd4mals9r01qjidhukr90';
        const POLYGON_KEY = 'EIlDyTzl0_zaQbLiC1lu5MqvRvg7ybmu';
        
        // Expanded stock universe with various price ranges
        const STOCKS = [
            'SPY', 'QQQ', 'IWM', 'AAPL', 'MSFT', 'TSLA', 'NVDA', 'AMD', 'GOOGL', 'META',
            'AMZN', 'F', 'SNAP', 'NIO', 'SOFI', 'PLTR', 'COIN', 'MARA', 'RIOT', 'BA',
            'DIS', 'AAL', 'CCL', 'DKNG', 'UBER', 'LYFT', 'RIVN', 'LCID', 'BABA', 'NFLX'
        ];
        
        let API_CACHE = {};
        const CACHE_TTL = 60000;

        // ==================== GUARANTEED SIGNAL ENGINE ====================
        function generateSignal(rsi, price, historicalPrices) {
            let type, signal, confidence;
            
            // PRIMARY: RSI-based signal (ALWAYS generates a signal)
            if (rsi < 30) {
                type = 'call';
                signal = 'Extremely Oversold - Strong Bounce Expected';
                confidence = 95;
            } else if (rsi < 40) {
                type = 'call';
                signal = 'Oversold - Bounce Expected';
                confidence = 85;
            } else if (rsi < 50) {
                type = 'call';
                signal = 'Below Midpoint - Upside Potential';
                confidence = 70;
            } else if (rsi < 60) {
                type = 'put';
                signal = 'Above Midpoint - Downside Potential';
                confidence = 70;
            } else if (rsi < 70) {
                type = 'put';
                signal = 'Overbought - Pullback Expected';
                confidence = 85;
            } else {
                type = 'put';
                signal = 'Extremely Overbought - Strong Pullback Expected';
                confidence = 95;
            }
            
            // FALLBACK: If RSI is missing, use trend analysis
            if (!rsi && historicalPrices && historicalPrices.length >= 5) {
                const recent5 = historicalPrices.slice(-5);
                const slope = (recent5[4] - recent5[0]) / 5;
                const ma20 = historicalPrices.slice(-20).reduce((a,b) => a + b, 0) / 20;
                
                if (price > ma20) {
                    type = 'call';
                    signal = 'Above 20-Day MA - Uptrend Continuation';
                    confidence = 65;
                } else {
                    type = 'put';
                    signal = 'Below 20-Day MA - Downtrend Continuation';
                    confidence = 65;
                }
            }
            
            // ULTIMATE FALLBACK: Random direction with low confidence
            if (!type) {
                type = price % 2 === 0 ? 'call' : 'put';
                signal = 'Neutral Market - Speculative Play';
                confidence = 50;
            }
            
            return { type, signal, confidence };
        }

        // ==================== BUDGET MODE ENGINE ====================
        function getBudgetStrategy(budget) {
            if (budget < 5) {
                return {
                    mode: 'lotto',
                    strikeMultiplier: { call: [1.20, 1.50], put: [0.50, 0.80] },
                    maxContracts: 1,
                    description: 'Ultra-Cheap Lotto Tickets'
                };
            } else if (budget < 50) {
                return {
                    mode: 'cheap',
                    strikeMultiplier: { call: [1.10, 1.30], put: [0.70, 0.90] },
                    maxContracts: 10,
                    description: 'Weekly OTM Options'
                };
            } else if (budget < 200) {
                return {
                    mode: 'otm',
                    strikeMultiplier: { call: [1.03, 1.12], put: [0.88, 0.97] },
                    maxContracts: 5,
                    description: 'OTM with Tight Spreads'
                };
            } else if (budget < 500) {
                return {
                    mode: 'atm',
                    strikeMultiplier: { call: [0.97, 1.05], put: [0.95, 1.03] },
                    maxContracts: 3,
                    description: 'ATM or Near-ATM'
                };
            } else {
                return {
                    mode: 'quality',
                    strikeMultiplier: { call: [0.93, 1.02], put: [0.98, 1.07] },
                    maxContracts: 2,
                    description: 'High-Probability ITM/ATM'
                };
            }
        }

        // ==================== API HELPERS ====================
        async function cachedFetch(url, key) {
            const now = Date.now();
            if (API_CACHE[key] && (now - API_CACHE[key].timestamp) < CACHE_TTL) {
                return API_CACHE[key].data;
            }
            try {
                const response = await fetch(url);
                const data = await response.json();
                API_CACHE[key] = { data, timestamp: now };
                return data;
            } catch (e) {
                return null;
            }
        }

        async function getPrice(ticker) {
            try {
                const data = await cachedFetch(
                    `https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${FINNHUB_KEY}`,
                    `price_${ticker}`
                );
                return data?.c || null;
            } catch (e) {
                return null;
            }
        }

        async function getHistoricalPrices(ticker) {
            try {
                const to = new Date();
                const from = new Date(to.getTime() - 30 * 24 * 60 * 60 * 1000);
                const url = `https://api.polygon.io/v2/aggs/ticker/${ticker}/range/1/day/${from.toISOString().split('T')[0]}/${to.toISOString().split('T')[0]}?adjusted=true&sort=asc&apiKey=${POLYGON_KEY}`;
                
                const data = await cachedFetch(url, `hist_${ticker}`);
                
                if (data?.status === 'ERROR' || !data?.results || data.results.length < 15) {
                    return null;
                }
                
                return data.results.map(item => item.c);
            } catch (e) {
                return null;
            }
        }

        function calculateRSI(prices) {
            if (!prices || prices.length < 15) return null;

            const changes = [];
            for (let i = 1; i < prices.length; i++) {
                changes.push(prices[i] - prices[i - 1]);
            }

            const last14 = changes.slice(-14);
            const gains = last14.filter(c => c > 0);
            const losses = last14.filter(c => c < 0);
            
            const avgGain = gains.length > 0 ? gains.reduce((sum, c) => sum + c, 0) / 14 : 0;
            const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((sum, c) => sum + c, 0)) / 14 : 0;

            if (avgLoss === 0) return avgGain > 0 ? 100 : 50;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function getNextFriday(daysAhead) {
            const d = new Date();
            d.setDate(d.getDate() + daysAhead);
            
            while (d.getDay() !== 5) {
                d.setDate(d.getDate() + 1);
            }
            
            return d.toISOString().split('T')[0];
        }

        // ==================== LIVE MARKET SCANNER ENGINE ====================
        async function scanMarketLive(ticker, budget, dte, budgetStrategy) {
            try {
                // 1. Fetch real-time price
                const price = await getPrice(ticker);
                if (!price) return null;

                // 2. Get 30-day candles & calculate RSI
                const hist = await getHistoricalPrices(ticker);
                if (!hist) return null;

                const rsi = calculateRSI(hist);
                
                // 3. Generate GUARANTEED signal
                const { type, signal, confidence } = generateSignal(rsi, price, hist);
                
                // 4. Fetch options chain
                const expDate = getNextFriday(dte);
                const option = await findBestOption(ticker, type, budget, price, expDate, budgetStrategy);
                
                if (!option) return null;

                // 5. Calculate profit simulation (10% move)
                const targetPrice = type === 'call' ? price * 1.10 : price * 0.90;
                const intrinsicValue = type === 'call' 
                    ? Math.max(0, targetPrice - option.strike)
                    : Math.max(0, option.strike - targetPrice);
                const profitPerContract = (intrinsicValue * 100) - (option.premium * 100);
                const totalProfit = profitPerContract * option.num;
                const roi = (totalProfit / parseFloat(option.total)) * 100;
                
                // 6. Calculate breakeven
                const breakeven = type === 'call'
                    ? option.strike + option.premium
                    : option.strike - option.premium;
                
                // 7. Calculate risk/reward score (0-100)
                const spreadQuality = option.bidPrice > 0 ? (1 - ((option.askPrice - option.bidPrice) / option.premium)) * 100 : 50;
                const profitPotential = Math.min(roi / 2, 50);
                const riskScore = Math.min(100, Math.max(0, (spreadQuality * 0.4 + profitPotential * 0.6)));

                return {
                    ticker,
                    price: price.toFixed(2),
                    rsi: rsi ? rsi.toFixed(1) : 'N/A',
                    signal: type.toUpperCase(),
                    confidence,
                    signalText: signal,
                    contract: `${expDate} $${option.strike.toFixed(2)}${type.charAt(0).toUpperCase()}`,
                    premium: option.premium.toFixed(2),
                    bid: option.bidPrice.toFixed(2),
                    ask: option.askPrice.toFixed(2),
                    numContracts: option.num,
                    totalCost: option.total,
                    expiration: expDate,
                    strike: option.strike,
                    breakeven: breakeven.toFixed(2),
                    profit: totalProfit.toFixed(2),
                    roi: roi.toFixed(1),
                    riskScore: riskScore.toFixed(0),
                    bestFor: budgetStrategy.description,
                    profitPotential: roi > 100 ? 'Very High' : (roi > 50 ? 'High' : 'Moderate')
                };
            } catch (e) {
                console.error(`Error scanning ${ticker}:`, e);
                return null;
            }
        }

        async function findBestOption(ticker, type, budget, currentPrice, expDate, budgetStrategy) {
            try {
                await new Promise(r => setTimeout(r, 250));
                
                const url = `https://api.polygon.io/v3/reference/options/contracts?underlying_ticker=${ticker}&expiration_date=${expDate}&limit=250&apiKey=${POLYGON_KEY}`;
                const data = await fetch(url).then(r => r.json());

                if (data.status === 'ERROR' || !data.results || data.results.length === 0) {
                    return null;
                }

                const [minStrike, maxStrike] = [
                    currentPrice * budgetStrategy.strikeMultiplier[type][0],
                    currentPrice * budgetStrategy.strikeMultiplier[type][1]
                ];
                
                const filtered = data.results.filter(c => {
                    const isRightType = c.contract_type === type.toLowerCase();
                    const strikeInRange = c.strike_price >= minStrike && c.strike_price <= maxStrike;
                    return isRightType && strikeInRange;
                });

                if (filtered.length === 0) return null;

                // Sort by strike (cheaper first)
                filtered.sort((a, b) => type === 'call' ? b.strike_price - a.strike_price : a.strike_price - b.strike_price);

                // Try top 15 strikes to find affordable option
                for (let i = 0; i < Math.min(15, filtered.length); i++) {
                    const contract = filtered[i];
                    
                    const quoteUrl = `https://api.polygon.io/v3/quotes/${contract.ticker}?limit=1&order=desc&apiKey=${POLYGON_KEY}`;
                    const quoteData = await fetch(quoteUrl).then(r => r.json());
                    
                    await new Promise(r => setTimeout(r, 250));
                    
                    if (quoteData.status === 'OK' && quoteData.results && quoteData.results.length > 0) {
                        const quote = quoteData.results[0];
                        const bidPrice = quote.bid_price || 0;
                        const askPrice = quote.ask_price || 0;
                        const midPrice = (bidPrice + askPrice) / 2;
                        
                        if (midPrice >= 0.01 && bidPrice > 0) {
                            const costPerContract = midPrice * 100;
                            const numContracts = Math.floor(budget / costPerContract);
                            
                            if (numContracts > 0 && numContracts <= budgetStrategy.maxContracts) {
                                return {
                                    strike: contract.strike_price,
                                    premium: midPrice,
                                    bidPrice: bidPrice,
                                    askPrice: askPrice,
                                    num: numContracts,
                                    total: (numContracts * costPerContract).toFixed(2)
                                };
                            }
                        }
                    }
                }
                
                return null;
            } catch (e) {
                return null;
            }
        }

        // ==================== ROBINHOOD INSTRUCTIONS ====================
        function generateRobinhoodSteps(ticker, strike, expiration, type) {
            const typeUpper = type.toUpperCase();
            const arrow = type === 'call' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
            const direction = type === 'call' ? 'UP' : 'DOWN';
            
            return `
                <div class="step"><span class="step-number">1</span>Open Robinhood app and search for <strong>${ticker}</strong></div>
                <div class="step"><span class="step-number">2</span>Tap "Trade" ‚Üí "Trade Options"</div>
                <div class="step"><span class="step-number">3</span>Select <strong>${typeUpper} ${arrow}</strong> (bet stock goes ${direction})</div>
                <div class="step"><span class="step-number">4</span>Pick expiration date closest to <strong>${expiration}</strong></div>
                <div class="step"><span class="step-number">5</span>Select strike price <strong>$${strike.toFixed(2)}</strong></div>
                <div class="step"><span class="step-number">6</span>Verify the price matches (check bid/ask spread)</div>
                <div class="step"><span class="step-number">7</span>Enter number of contracts</div>
                <div class="step"><span class="step-number">8</span>Use <strong>LIMIT order</strong> at mid-price</div>
                <div class="step"><span class="step-number">9</span>Review total cost and confirm</div>
                <div class="step"><span class="step-number">10</span>Tap "Buy" and track your position! üí∞</div>
            `;
        }

        // ==================== UI RENDERING ====================
        function renderTrade(trade, rank) {
            const typeClass = trade.signal.toLowerCase();
            const confidenceClass = trade.confidence >= 80 ? 'high' : (trade.confidence >= 65 ? 'medium' : 'low');
            const confidenceLabel = trade.confidence >= 80 ? `${trade.confidence}% High` : (trade.confidence >= 65 ? `${trade.confidence}% Medium` : `${trade.confidence}% Moderate`);
            const arrow = typeClass === 'call' ? 'üìà' : 'üìâ';
            const direction = typeClass === 'call' ? 'UP' : 'DOWN';
            
            return `
                <div class="trade-card ${typeClass}">
                    <div class="rank-badge">#${rank}</div>
                    <div class="confidence-badge confidence-${confidenceClass}">${confidenceLabel}</div>
                    
                    <div class="trade-header ${typeClass}">
                        <h3>${arrow} BUY ${trade.signal}</h3>
                        <p>${trade.ticker} - ${trade.signalText}</p>
                    </div>
                    
                    <div class="trade-meta">
                        <div class="meta-item">
                            <div class="meta-label">Current Price</div>
                            <div class="meta-value" style="color: #10b981;">$${trade.price}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">RSI</div>
                            <div class="meta-value" style="color: ${parseFloat(trade.rsi) < 50 ? '#10b981' : '#ef4444'};">${trade.rsi}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Breakeven</div>
                            <div class="meta-value">$${trade.breakeven}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Profit Potential</div>
                            <div class="meta-value" style="color: #fbbf24;">${trade.profitPotential}</div>
                        </div>
                    </div>
                    
                    <div class="contract-details">
                        <h4 style="color: #38bdf8; margin-bottom: 15px;">üìã Contract Details</h4>
                        <div class="detail-row">
                            <span class="detail-label">Contract</span>
                            <span class="detail-value">${trade.contract}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Premium (per contract)</span>
                            <span class="detail-value">$${trade.premium}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Bid / Ask</span>
                            <span class="detail-value">$${trade.bid} / $${trade.ask}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Number of Contracts</span>
                            <span class="detail-value">${trade.numContracts}</span>
                        </div>
                        <div class="detail-row" style="background: #0a1929; padding: 12px; border-radius: 6px; margin-top: 10px;">
                            <span class="detail-label" style="color: #fbbf24; font-weight: bold;">TOTAL COST</span>
                            <span class="detail-value" style="color: #ef4444; font-size: 1.4rem;">$${trade.totalCost}</span>
                        </div>
                    </div>
                    
                    <div class="budget-tag">${trade.bestFor}</div>
                    
                    <div class="profit-section">
                        <h4>üí∞ Expected Profit (10% Move ${direction})</h4>
                        <div class="profit-amount">+$${trade.profit}</div>
                        <div class="roi">${trade.roi}% Return on Investment</div>
                        <p style="font-size: 0.9rem; margin-top: 10px; color: #e0f2fe;">Based on ${trade.ticker} moving 10% in favorable direction</p>
                    </div>
                    
                    <div class="risk-score">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #94a3b8;">Risk/Reward Score</span>
                            <span style="color: #10b981; font-weight: bold;">${trade.riskScore}/100</span>
                        </div>
                        <div class="risk-score-bar">
                            <div class="risk-score-fill" style="width: ${trade.riskScore}%;"></div>
                        </div>
                        <p style="color: #64748b; font-size: 0.85rem; margin-top: 8px;">
                            Considers spread quality, profit potential, and market conditions
                        </p>
                    </div>
                    
                    <div class="instructions">
                        <h4>üì± How to Execute in Robinhood</h4>
                        ${generateRobinhoodSteps(trade.ticker, trade.strike, trade.expiration, typeClass)}
                    </div>
                </div>
            `;
        }

        // ==================== MAIN SCAN FUNCTION ====================
        async function scanMarket() {
            const budget = parseFloat(document.getElementById('budget').value);
            const dte = parseInt(document.getElementById('dte').value);

            if (!budget || budget <= 0) {
                alert('‚ö†Ô∏è Please enter a valid budget amount');
                return;
            }

            // UI state
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('results').innerHTML = '';

            const budgetStrategy = getBudgetStrategy(budget);
            const allTrades = [];

            try {
                // Scan all tickers
                for (let i = 0; i < STOCKS.length; i++) {
                    const ticker = STOCKS[i];
                    const progress = ((i + 1) / STOCKS.length * 100).toFixed(0);
                    
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('loadingText').textContent = `Analyzing ${ticker}... (${i + 1}/${STOCKS.length})`;
                    
                    const trade = await scanMarketLive(ticker, budget, dte, budgetStrategy);
                    if (trade) {
                        allTrades.push(trade);
                    }
                    
                    // Stop early if we have enough good trades
                    if (allTrades.length >= 10 && i >= 10) {
                        break;
                    }
                    
                    await new Promise(r => setTimeout(r, 600));
                }

                // GUARANTEE 3 TRADES: Sort and categorize
                allTrades.sort((a, b) => {
                    // Primary sort: confidence
                    if (b.confidence !== a.confidence) {
                        return b.confidence - a.confidence;
                    }
                    // Secondary sort: ROI
                    return parseFloat(b.roi) - parseFloat(a.roi);
                });

                // Select top 3 diverse opportunities
                const top3 = selectTop3Trades(allTrades, budget);

                // Render results
                if (top3.length === 0) {
                    // ULTIMATE FALLBACK: Show API error
                    document.getElementById('results').innerHTML = `
                        <div style="background: #1e293b; padding: 40px; border-radius: 12px; text-align: center;">
                            <h2 style="color: #ef4444; margin-bottom: 15px;">‚ö†Ô∏è Unable to Connect</h2>
                            <p style="color: #94a3b8;">Cannot reach market data APIs. Please check your connection and try again.</p>
                            <button onclick="scanMarket()" style="margin-top: 20px; padding: 12px 24px; background: #10b981; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">Retry Scan</button>
                        </div>
                    `;
                } else {
                    let html = `
                        <div class="results-header">
                            <h2>üéØ Your Top ${top3.length} Opportunities</h2>
                            <p>Customized for your $${budget.toFixed(2)} budget ‚Ä¢ ${budgetStrategy.description}</p>
                        </div>
                    `;
                    top3.forEach((trade, i) => {
                        html += renderTrade(trade, i + 1);
                    });
                    document.getElementById('results').innerHTML = html;
                }

                document.getElementById('results').classList.add('active');
            } catch (error) {
                console.error('Scan error:', error);
                document.getElementById('results').innerHTML = `
                    <div style="background: #1e293b; padding: 40px; border-radius: 12px; text-align: center;">
                        <h2 style="color: #ef4444; margin-bottom: 15px;">‚ùå Scan Error</h2>
                        <p style="color: #94a3b8;">${error.message}</p>
                    </div>
                `;
                document.getElementById('results').classList.add('active');
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('scanBtn').disabled = false;
            }
        }

        // ==================== TOP 3 SELECTION ALGORITHM ====================
        function selectTop3Trades(trades, budget) {
            if (trades.length === 0) return [];
            if (trades.length <= 3) return trades;

            const selected = [];
            
            // 1. Best overall (highest confidence + ROI)
            selected.push(trades[0]);
            
            // 2. Cheapest affordable (lowest cost but still good quality)
            const cheapest = trades
                .filter(t => !selected.includes(t) && parseFloat(t.totalCost) < budget * 0.5)
                .sort((a, b) => parseFloat(a.totalCost) - parseFloat(b.totalCost))[0];
            if (cheapest) selected.push(cheapest);
            
            // 3. Highest ROI potential (aggressive but higher reward)
            const highestROI = trades
                .filter(t => !selected.includes(t))
                .sort((a, b) => parseFloat(b.roi) - parseFloat(a.roi))[0];
            if (highestROI) selected.push(highestROI);
            
            // Fill remaining slots if needed
            while (selected.length < 3 && selected.length < trades.length) {
                const next = trades.find(t => !selected.includes(t));
                if (next) selected.push(next);
                else break;
            }
            
            return selected;
        }

        // ==================== INIT ====================
        window.addEventListener('load', () => {
            console.log('‚úÖ Options Hunter Pro - Guaranteed Opportunities Mode');
            console.log('üìä Always returns 3 trades for ANY budget');
        });
    </script>
</body>
</html>

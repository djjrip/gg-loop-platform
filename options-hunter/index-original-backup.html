<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>AI Options Advisor - REAL DATA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(to right, #4ade80, #38bdf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .money-tracker {
            background: linear-gradient(135deg, #065f46, #047857);
            border: 3px solid #10b981;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .tracker-header {
            font-size: 1.8rem;
            color: #10b981;
            margin-bottom: 20px;
            text-align: center;
        }

        .active-trades {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .trade-item {
            background: #1e293b;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        .trade-item.sell-now {
            border-left: 4px solid #fbbf24;
            background: linear-gradient(135deg, #451a03, #78350f);
            animation: sellPulse 1s infinite;
        }

        @keyframes sellPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .profit-calc {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #4ade80;
        }

        .profit-big {
            font-size: 2rem;
            color: #4ade80;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        .simple-button {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: transform 0.2s;
        }

        .simple-button:hover {
            transform: scale(1.05);
        }

        .buy-button {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
        }

        .sell-button {
            background: linear-gradient(135deg, #d97706, #f59e0b);
            color: white;
        }

        .track-button {
            background: linear-gradient(135deg, #0284c7, #0ea5e9);
            color: white;
        }

        .live {
            background: linear-gradient(135deg, #059669, #10b981);
            border: 2px solid #4ade80;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .setup {
            background: #1e293b;
            border: 2px solid #38bdf8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .setup input {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            color: #f8fafc;
            margin: 10px 0;
        }

        .setup button {
            padding: 12px 24px;
            background: #4ade80;
            color: #0f172a;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .warning {
            background: linear-gradient(135deg, #7c2d12, #991b1b);
            border: 2px solid #f87171;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .explainer {
            background: linear-gradient(135deg, #1e3a5f, #2a4a6f);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #38bdf8;
        }

        .explainer h3 {
            color: #38bdf8;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .step {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #4ade80;
        }

        .step-number {
            display: inline-block;
            background: #4ade80;
            color: #0f172a;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: bold;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .controls {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #334155;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: #e0f2fe;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .help-text {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 14px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            color: #f8fafc;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        input:focus,
        select:focus {
            border-color: #4ade80;
            outline: none;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4ade80, #3b82f6);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.5;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #1e293b;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #38bdf8);
            transition: width 0.3s;
        }

        .log {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: monospace;
        }

        .log-scan {
            background: #1e293b;
            color: #94a3b8;
        }

        .log-signal {
            background: #1e3a8a;
            color: #93c5fd;
            font-weight: bold;
        }

        .log-pass {
            background: #14532d;
            color: #86efac;
        }

        .log-error {
            background: #7c2d12;
            color: #fca5a5;
        }

        .trade {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 3px solid;
            position: relative;
        }

        .trade.call {
            border-color: #4ade80;
        }

        .trade.put {
            border-color: #f87171;
        }

        .rank {
            position: absolute;
            top: -15px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #0f172a;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .confidence-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            border: 2px solid #fca5a5;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .confidence-badge.must-buy {
            background: linear-gradient(135deg, #059669, #10b981);
            border-color: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .banner {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .banner h2 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 10px;
        }

        .banner p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .info {
            background: #1e3a5f;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .info-row {
            background: #0f172a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .info-label {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #f8fafc;
        }

        .real-price {
            color: #4ade80;
            font-weight: bold;
        }

        .profit {
            background: linear-gradient(135deg, #4ade80, #3b82f6);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .profit h2 {
            font-size: 2.5rem;
            color: white;
            margin: 10px 0;
        }

        .profit p {
            color: #e0f2fe;
            font-size: 1.1rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ü§ñ AI Options Advisor</h1>
        <p class="subtitle">REAL Market Data - Accurate Prices & Analysis</p>

        <div class="live">
            <h3 style="color: #d1fae5;">üü¢ LIVE MODE - Real Option Prices from Polygon.io</h3>
        </div>

        <div class="setup" id="setup">
            <h3 style="color: #38bdf8; margin-bottom: 15px;">üîë Quick Setup - Get Polygon.io API Key (Free)</h3>
            <ol style="margin: 15px 0 15px 20px; color: #cbd5e1; line-height: 1.8;">
                <li>Go to <a href="https://polygon.io/dashboard/signup" target="_blank"
                        style="color: #38bdf8;">polygon.io/dashboard/signup</a></li>
                <li>Sign up for FREE tier (no credit card needed)</li>
                <li>Copy your API key from dashboard</li>
                <li>Paste below</li>
            </ol>
            <input type="text" id="polyKey" placeholder="Paste your Polygon.io API key here">
            <button onclick="saveKey()">üíæ Save & Start</button>
            <p style="margin-top: 10px; font-size: 0.9rem; color: #64748b;">Your key is stored locally in browser only
            </p>
        </div>

        <div class="warning">
            <h3 style="color: #fca5a5; margin-bottom: 10px;">‚ö†Ô∏è Risk Warning</h3>
            <p>Options trading is extremely risky. You can lose 100% of your investment. This tool provides data-driven
                analysis but NO GUARANTEES. You are responsible for your own trades.</p>
        </div>

        <div class="explainer">
            <h3>üéì Here's How This Works (Simple Version)</h3>
            <div class="step">
                <span class="step-number">1</span>
                <strong>We scan stocks</strong> to find ones that are either "way too cheap" or "way too expensive" right now
            </div>
            <div class="step">
                <span class="step-number">2</span>
                <strong>When a stock is "way too cheap"</strong> ‚Üí It's likely to bounce back UP ‚Üí We tell you to buy a CALL
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <strong>When a stock is "way too expensive"</strong> ‚Üí It's likely to drop DOWN ‚Üí We tell you to buy a PUT
            </div>
            <div class="step">
                <span class="step-number">4</span>
                <strong>We show you EXACTLY what to buy:</strong> Which contract, how many, what it costs (using REAL market prices), and how much profit you could make
            </div>
        </div>

        <!-- MY TRADES TRACKER -->
        <div class="money-tracker" id="tracker" style="display:none;">
            <h2 class="tracker-header">üí∞ MY TRADES - Track Your Money!</h2>
            
            <div class="active-trades" id="activeTrades">
                <h3 style="color: #10b981; margin-bottom: 15px;">üìä Active Trades (Options You Own Now)</h3>
                <div id="tradesList"></div>
                <p id="noTrades" style="color: #64748b; text-align: center; padding: 20px;">
                    No trades yet! Scan the market and click "Track This Trade" after buying.
                </p>
            </div>

            <div class="profit-calc" id="totalProfit" style="display:none;">
                <h3 style="color: #4ade80; text-align: center;">üíµ Total Profit/Loss</h3>
                <div class="profit-big" id="totalProfitAmount">$0.00</div>
                <p style="text-align: center; color: #94a3b8;">From all your active trades</p>
            </div>
        </div>

        <div class="controls" id="controls" style="display:none;">
            <div class="grid">
                <div class="input-group">
                    <label>üíµ How Much Money Do You Want to Spend?</label>
                    <input type="number" id="budget" value="500" min="1" placeholder="Enter any amount" step="0.01">
                    <p class="help-text">üí° Enter ANY amount - we'll find what you can afford (even $1!)</p>
                </div>
                <div class="input-group">
                    <label>‚è±Ô∏è How Long Until the Contract Expires?</label>
                    <select id="dte">
                        <option value="7">1 Week (Risky, but cheaper)</option>
                        <option value="14">2 Weeks</option>
                        <option value="30" selected>1 Month (Recommended)</option>
                    </select>
                    <p class="help-text">üí° Longer = More time for the trade to work out</p>
                </div>
            </div>
            <button onclick="scan()">üöÄ Analyze Market with Real Data</button>
        </div>

        <div id="prog" style="display:none;">
            <div class="progress">
                <div class="progress-bar" id="bar"></div>
            </div>
            <div class="log">
                <h3 style="color: #38bdf8; margin-bottom: 15px;">üìä Live Analysis</h3>
                <div id="log"></div>
            </div>
        </div>

        <div id="out"></div>
    </div>

    <script>
        const FINNHUB_KEY = 'd4mals9r01qjidhukr8gd4mals9r01qjidhukr90';
        let POLY_KEY = 'iYgk51katdN5xUr9wINrIDuoRqRV8TNb';
        const STOCKS = ['SPY', 'QQQ', 'IWM', 'AAPL', 'MSFT', 'TSLA', 'NVDA', 'AMD', 'GOOGL', 'META', 'AMZN', 'NFLX', 'DIS', 'BA', 'COIN', 'PLTR', 'F', 'SNAP', 'NIO', 'LCID', 'SOFI', 'SQQQ', 'TQQQ', 'UVXY', 'CCL', 'AAL', 'T', 'WBD', 'INTC', 'VALE'];

        if (POLY_KEY && POLY_KEY !== 'd4mals9r01qjidhukr8gd4mals9r01qjidhukr90') {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
        }

        function saveKey() {
            const key = document.getElementById('polyKey').value.trim();
            if (!key) { alert('Please enter your API key!'); return; }
            localStorage.setItem('polygon_api_key', key);
            POLY_KEY = key;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
        }

        function log(msg, type) {
            const d = document.getElementById('log');
            const e = document.createElement('div');
            e.className = 'log-entry log-' + type;
            e.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
            d.appendChild(e);
            d.scrollTop = d.scrollHeight;
        }

        // Get next Friday (options expiration day)
        function getNextFriday(daysAhead) {
            const d = new Date();
            d.setDate(d.getDate() + daysAhead);
            
            // Find the next Friday
            while (d.getDay() !== 5) {
                d.setDate(d.getDate() + 1);
            }
            
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        async function getPrice(ticker) {
            try {
                const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${FINNHUB_KEY}`);
                const d = await r.json();
                return d.c || null;
            } catch (e) { 
                log('Error fetching price for ' + ticker + ': ' + e.message, 'error');
                return null; 
            }
        }

        async function getHistoricalPrices(ticker) {
            try {
                const to = new Date();
                const from = new Date(to.getTime() - 30 * 24 * 60 * 60 * 1000);
                const toStr = to.toISOString().split('T')[0];
                const fromStr = from.toISOString().split('T')[0];
                const url = `https://api.polygon.io/v2/aggs/ticker/${ticker}/range/1/day/${fromStr}/${toStr}?adjusted=true&sort=asc&apiKey=${POLY_KEY}`;
                
                const r = await fetch(url);
                const d = await r.json();
                
                if (d.status === 'ERROR' || !d.results) {
                    log('Polygon API error for ' + ticker + ': ' + (d.error || 'No data'), 'error');
                    return null;
                }
                
                if (d.results && d.results.length >= 15) {
                    return d.results.map(item => item.c);
                }
                return null;
            } catch (e) { 
                log('Historical data error for ' + ticker + ': ' + e.message, 'error');
                return null; 
            }
        }

        function calculateRSI(prices) {
            if (!prices || prices.length < 15) return null;

            const changes = [];
            for (let i = 1; i < prices.length; i++) {
                changes.push(prices[i] - prices[i - 1]);
            }

            const last14 = changes.slice(-14);
            const gains = last14.filter(c => c > 0);
            const losses = last14.filter(c => c < 0);
            
            const avgGain = gains.length > 0 ? gains.reduce((sum, c) => sum + c, 0) / 14 : 0;
            const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((sum, c) => sum + c, 0)) / 14 : 0;

            if (avgLoss === 0) return avgGain > 0 ? 100 : 50;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        async function getOptionsSnapshot(ticker) {
            try {
                // Try to get aggregated option quotes from Polygon
                const url = `https://api.polygon.io/v3/snapshot/options/${ticker}?apiKey=${POLY_KEY}`;
                const r = await fetch(url);
                const d = await r.json();
                
                if (d.status === 'OK' && d.results && d.results.length > 0) {
                    return d.results;
                }
                return null;
            } catch (e) {
                log('Options snapshot error for ' + ticker + ': ' + e.message, 'error');
                return null;
            }
        }

        async function findBestOption(ticker, type, budget, currentPrice, expDate) {
            try {
                log('Fetching options chain for ' + ticker + '...', 'scan');
                
                // Get available option contracts for expiration date
                const url = `https://api.polygon.io/v3/reference/options/contracts?underlying_ticker=${ticker}&expiration_date=${expDate}&limit=250&apiKey=${POLY_KEY}`;
                const r = await fetch(url);
                const d = await r.json();

                if (d.status === 'ERROR' || !d.results || d.results.length === 0) {
                    log('No options found for ' + ticker + ' exp ' + expDate, 'error');
                    return null;
                }

                // Filter for right contract type - WIDER strike range to find cheaper options
                const filtered = d.results.filter(c => {
                    const isRightType = c.contract_type === type.toLowerCase();
                    // Look at OTM options too (they're cheaper)
                    const strikeInRange = type === 'call' 
                        ? (c.strike_price >= currentPrice * 0.90 && c.strike_price <= currentPrice * 1.15)
                        : (c.strike_price >= currentPrice * 0.85 && c.strike_price <= currentPrice * 1.10);
                    return isRightType && strikeInRange;
                });

                if (filtered.length === 0) {
                    log('No suitable strikes found for ' + ticker, 'error');
                    return null;
                }

                // Sort by strike to get OTM options first (cheaper)
                filtered.sort((a, b) => {
                    if (type === 'call') {
                        return b.strike_price - a.strike_price; // Higher strikes = cheaper calls
                    } else {
                        return a.strike_price - b.strike_price; // Lower strikes = cheaper puts
                    }
                });

                // Try ALL strikes to find something affordable
                for (let i = 0; i < filtered.length; i++) {
                    const contract = filtered[i];
                    
                    const contractTicker = contract.ticker;
                    
                    // Get last quote
                    const quoteUrl = `https://api.polygon.io/v3/quotes/${contractTicker}?limit=1&order=desc&apiKey=${POLY_KEY}`;
                    const quoteResp = await fetch(quoteUrl);
                    const quoteData = await quoteResp.json();
                    
                    await new Promise(r => setTimeout(r, 250)); // Faster rate limiting
                    
                    if (quoteData.status === 'OK' && quoteData.results && quoteData.results.length > 0) {
                        const quote = quoteData.results[0];
                        const bidPrice = quote.bid_price || 0;
                        const askPrice = quote.ask_price || 0;
                        const midPrice = (bidPrice + askPrice) / 2;
                        
                        // Accept ANY price > $0.01
                        if (midPrice >= 0.01 && bidPrice > 0) {
                            const costPerContract = midPrice * 100;
                            const numContracts = Math.floor(budget / costPerContract);
                            
                            // Return it even if can't afford full contract - show what exists
                            if (numContracts > 0) {
                                const totalCost = numContracts * costPerContract;
                                
                                log('‚úÖ Found affordable option: ' + contractTicker + ' @ $' + midPrice.toFixed(2) + ' x ' + numContracts, 'pass');
                                
                                return {
                                    strike: contract.strike_price,
                                    premium: midPrice,
                                    bidPrice: bidPrice,
                                    askPrice: askPrice,
                                    num: numContracts,
                                    total: totalCost.toFixed(2),
                                    contract: contractTicker,
                                    expDate: expDate,
                                    affordable: true
                                };
                            }
                        }
                    }
                    
                    // Don't scan all 250 - just try first 10 strikes
                    if (i >= 10) break;
                }
                
                log('üí° ' + ticker + ': All options cost more than $' + budget.toFixed(2), 'scan');
                return null;
                
            } catch (e) {
                log('Error finding option for ' + ticker + ': ' + e.message, 'error');
                return null;
            }
        }

        async function scan() {
            const budget = parseFloat(document.getElementById('budget').value) || 500;
            const dte = parseInt(document.getElementById('dte').value);
            const expDate = getNextFriday(dte);

            if (!budget || budget <= 0) {
                alert('‚ö†Ô∏è Please enter a budget amount greater than $0');
                return;
            }

            document.getElementById('prog').style.display = 'block';
            document.getElementById('out').innerHTML = '';
            document.getElementById('log').innerHTML = '';

            log('üöÄ Starting REAL market analysis with Polygon.io data...', 'scan');
            log('üí∞ Your Budget: $' + budget.toFixed(2) + ' | Target Expiration: ' + expDate + ' (Friday)', 'pass');
            if (budget < 100) {
                log('üîç Low budget mode - scanning for cheap OTM options and penny stocks', 'scan');
            }
            log('üìä Analyzing ' + STOCKS.length + ' stocks (includes cheap options like F, SNAP, NIO, SOFI)...', 'scan');

            const trades = [];
            for (let i = 0; i < STOCKS.length; i++) {
                const t = STOCKS[i];
                document.getElementById('bar').style.width = ((i + 1) / STOCKS.length * 100) + '%';
                
                log('[' + (i + 1) + '/' + STOCKS.length + '] Fetching data for ' + t + '...', 'scan');

                const price = await getPrice(t);
                if (!price) { 
                    log(t + ': ‚ùå No current price available', 'error'); 
                    continue; 
                }

                const hist = await getHistoricalPrices(t);
                if (!hist) { 
                    log(t + ': ‚ùå No historical data (check Polygon API key)', 'error'); 
                    continue; 
                }

                const rsi = calculateRSI(hist);
                if (rsi === null) {
                    log(t + ': ‚ùå Insufficient data for RSI calculation', 'error');
                    continue;
                }

                log(t + ': Current Price $' + price.toFixed(2) + ' | RSI ' + rsi.toFixed(1), 'scan');

                // OVERSOLD = Bullish reversal potential (BUY CALLS)
                if (rsi < 35) {
                    log(t + ': üü¢ OVERSOLD (RSI ' + rsi.toFixed(1) + ') - Fetching CALL options...', 'signal');
                    const opt = await findBestOption(t, 'call', budget, price, expDate);
                    
                    if (opt) {
                        // Profit calc: assume 15% upside move
                        const targetPrice = price * 1.15;
                        const intrinsicValue = Math.max(0, targetPrice - opt.strike);
                        const profitPerContract = (intrinsicValue * 100) - (opt.premium * 100);
                        const totalProfit = profitPerContract * opt.num;
                        const roiPercent = (totalProfit / parseFloat(opt.total)) * 100;
                        
                        trades.push({
                            t,
                            price: price.toFixed(2),
                            rsi: rsi.toFixed(1),
                            type: 'call',
                            exp: opt.expDate,
                            score: Math.abs(rsi - 50),
                            profit: totalProfit.toFixed(2),
                            roi: roiPercent.toFixed(1),
                            ...opt
                        });
                        log('‚úÖ ' + t + ' CALL added: Strike $' + opt.strike + ' @ $' + opt.premium.toFixed(2) + ' x ' + opt.num + ' contracts = $' + opt.total, 'pass');
                    } else {
                        log('üí° ' + t + ' CALL: Cheapest option costs more than $' + budget.toFixed(2) + ' budget', 'scan');
                    }
                } 
                // OVERBOUGHT = Bearish reversal potential (BUY PUTS)
                else if (rsi > 65) {
                    log(t + ': üî¥ OVERBOUGHT (RSI ' + rsi.toFixed(1) + ') - Fetching PUT options...', 'signal');
                    const opt = await findBestOption(t, 'put', budget, price, expDate);
                    
                    if (opt) {
                        // Profit calc: assume 15% downside move
                        const targetPrice = price * 0.85;
                        const intrinsicValue = Math.max(0, opt.strike - targetPrice);
                        const profitPerContract = (intrinsicValue * 100) - (opt.premium * 100);
                        const totalProfit = profitPerContract * opt.num;
                        const roiPercent = (totalProfit / parseFloat(opt.total)) * 100;
                        
                        trades.push({
                            t,
                            price: price.toFixed(2),
                            rsi: rsi.toFixed(1),
                            type: 'put',
                            exp: opt.expDate,
                            score: Math.abs(rsi - 50),
                            profit: totalProfit.toFixed(2),
                            roi: roiPercent.toFixed(1),
                            ...opt
                        });
                        log('‚úÖ ' + t + ' PUT added: Strike $' + opt.strike + ' @ $' + opt.premium.toFixed(2) + ' x ' + opt.num + ' contracts = $' + opt.total, 'pass');
                    } else {
                        log('üí° ' + t + ' PUT: Cheapest option costs more than $' + budget.toFixed(2) + ' budget', 'scan');
                    }
                } else {
                    log(t + ': Neutral (RSI ' + rsi.toFixed(1) + ') - Skipping', 'scan');
                }

                // Rate limiting to avoid API throttling
                await new Promise(r => setTimeout(r, 600));
            }

            log('‚úÖ Market scan complete! Found ' + trades.length + ' opportunities with real option prices', 'pass');
            
            if (trades.length > 0) {
                // Sort by profit potential (highest first)
                trades.sort((a, b) => parseFloat(b.profit) - parseFloat(a.profit));
                show(trades.slice(0, 3));
            } else {
                show([]);
            }
        }

        function show(trades) {
            if (trades.length === 0) {
                document.getElementById('out').innerHTML = '<div style="background:#1e293b;border-radius:12px;padding:60px;text-align:center;"><h2 style="font-size:2rem;color:#64748b;margin-bottom:15px;">üìä No Strong Signals Right Now</h2><p style="color:#94a3b8;font-size:1.1rem;">Market conditions are neutral (RSI between 35-65 for all scanned stocks).</p><p style="color:#64748b;margin-top:10px;">Try again later or adjust your scan parameters.</p></div>';
                return;
            }

            let h = '<div style="background:#1e293b;border-radius:12px;padding:25px;margin-top:20px;"><h2 style="color:#4ade80;margin-bottom:25px;">üéØ Top ' + trades.length + ' Opportunities (Ranked by Profit Potential)</h2>';
            h += '<p style="color:#94a3b8;margin-bottom:25px;">‚ö†Ô∏è These are REAL option prices from the market. Verify bid/ask in Robinhood before buying.</p>';
            
            trades.forEach((tr, i) => {
                const bg = tr.type === 'call' ? 'linear-gradient(135deg,#059669,#10b981)' : 'linear-gradient(135deg,#dc2626,#ef4444)';
                const bd = tr.type === 'call' ? '#4ade80' : '#fca5a5';
                const arrow = tr.type === 'call' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                const direction = tr.type === 'call' ? 'UP' : 'DOWN';
                
                // Determine confidence based on RSI extremeness
                const rsiValue = parseFloat(tr.rsi);
                const isMustBuy = (tr.type === 'call' && rsiValue < 25) || (tr.type === 'put' && rsiValue > 75);
                const confidenceBadge = isMustBuy 
                    ? '<div class="confidence-badge must-buy">üî• MUST BUY</div>'
                    : '<div class="confidence-badge">‚≠ê Strong Buy</div>';
                
                h += '<div class="trade ' + tr.type + '"><div class="rank">#' + (i + 1) + '</div>';
                h += confidenceBadge;
                h += '<div class="banner" style="background:' + bg + ';border:3px solid ' + bd + ';">';
                h += '<h2>' + (tr.type === 'call' ? 'üìà BUY A CALL' : 'üìâ BUY A PUT') + '</h2>';
                h += '<p style="font-size:1.3rem;">Bet that ' + tr.t + ' goes ' + direction + ' ' + arrow + '</p></div>';
                
                h += '<h3 style="font-size:2.2rem;margin:20px 0 10px 0;">' + tr.t + '</h3>';
                h += '<p style="color:#94a3b8;font-size:1.1rem;margin-bottom:20px;">Current Price: <span style="color:#4ade80;font-weight:bold;">$' + tr.price + '</span> | RSI: <span style="color:' + (tr.rsi < 35 ? '#4ade80' : '#f87171') + ';font-weight:bold;">' + tr.rsi + '</span></p>';
                
                h += '<div class="info"><h4 style="color:#38bdf8;margin-bottom:20px;font-size:1.3rem;">üì± How to Execute in Robinhood:</h4>';
                
                h += '<div class="info-row" style="background:#0a1929;border:2px solid #38bdf8;"><div class="info-label" style="font-size:1.05rem;color:#38bdf8;">Step 1: Open Robinhood App</div><div class="info-value" style="font-size:1.4rem;">Search for: ' + tr.t + '</div></div>';
                
                h += '<div class="info-row"><div class="info-label">Step 2: Tap "Trade" ‚Üí "Trade Options"</div></div>';
                
                h += '<div class="info-row"><div class="info-label">Step 3: Select Contract Type</div><div class="info-value" style="color:' + bd + ';">' + tr.type.toUpperCase() + ' ' + arrow + '</div></div>';
                
                h += '<div class="info-row" style="background:#0a1929;border:1px solid #4ade80;"><div class="info-label">Step 4: Expiration Date (pick closest to)</div><div class="info-value" style="color:#4ade80;">' + tr.exp + '</div></div>';
                
                h += '<div class="info-row" style="background:#0a1929;border:1px solid #4ade80;"><div class="info-label">Step 5: Strike Price (pick closest to)</div><div class="info-value" style="color:#4ade80;">$' + tr.strike.toFixed(2) + '</div></div>';
                
                h += '<div class="info-row"><div class="info-label">Step 6: Number of Contracts</div><div class="info-value">' + tr.num + ' contract' + (tr.num > 1 ? 's' : '') + '</div></div>';
                
                h += '<div class="info-row" style="background:#1e3a5f;border:2px solid #fbbf24;"><div class="info-label" style="color:#fbbf24;font-weight:bold;">Step 7: CHECK THE PRICE IN ROBINHOOD</div><div class="info-value"><div style="margin-bottom:8px;">Bid: <span style="color:#f87171;">$' + (tr.bidPrice || tr.premium * 0.98).toFixed(2) + '</span> | Ask: <span style="color:#4ade80;">$' + (tr.askPrice || tr.premium * 1.02).toFixed(2) + '</span></div><div style="font-size:1.1rem;color:#94a3b8;">Mid Price: $' + tr.premium.toFixed(2) + '</div></div></div>';
                
                h += '<div class="info-row" style="background:#0a1929;border:2px solid #f87171;"><div class="info-label" style="color:#fca5a5;">Step 8: TOTAL COST (verify in app)</div><div class="info-value" style="color:#f87171;font-size:1.6rem;">$' + tr.total + '</div><div style="margin-top:5px;font-size:0.9rem;color:#94a3b8;">(' + tr.num + ' contracts √ó $' + tr.premium.toFixed(2) + ' √ó 100)</div></div>';
                
                h += '<div class="info-row" style="background:#1e3a5f;"><div class="info-label" style="color:#38bdf8;">Step 9: Set Limit Order</div><div class="info-value" style="font-size:1.1rem;color:#e0f2fe;">Use LIMIT order at mid-price ($' + tr.premium.toFixed(2) + ') or slightly better</div></div>';
                
                h += '<div class="info-row" style="background:#0f4c5c;"><div class="info-label">Step 10: Review & Confirm</div><div class="info-value" style="font-size:1.05rem;color:#d1fae5;">Double-check everything matches ‚Üí Tap "Buy"</div></div>';
                
                h += '</div>'; // Close info div
                
                // Profit projection
                h += '<div class="profit" style="margin-top:20px;"><p style="font-size:1.1rem;margin-bottom:10px;">üí∞ <strong>If ' + tr.t + ' moves 15% ' + direction + ':</strong></p>';
                h += '<h2 style="font-size:3rem;margin:10px 0;">+$' + tr.profit + '</h2>';
                h += '<p style="font-size:1.2rem;color:#d1fae5;"><strong>' + tr.roi + '% ROI</strong> on your $' + tr.total + ' investment</p>';
                h += '<p style="font-size:0.9rem;color:#e0f2fe;margin-top:10px;">‚ö†Ô∏è This is a projection, not a guarantee. Options can expire worthless.</p></div>';
                
                // TRACK THIS TRADE BUTTON
                h += '<button class="track-button" onclick="trackTrade(\'' + tr.t + '\', \'' + tr.type + '\', ' + tr.strike + ', \'' + tr.exp + '\', ' + tr.premium + ', ' + tr.num + ', ' + tr.total + ')" style="margin-top:20px;width:100%;">üìä TRACK THIS TRADE</button>';
                
                h += '</div>'; // Close trade card
            });
            
            document.getElementById('out').innerHTML = h + '</div>';
        }

        // ===== TRADE TRACKER FUNCTIONS =====
        
        function trackTrade(ticker, type, strike, exp, buyPrice, contracts, totalCost) {
            const trades = getTrades();
            
            // Create trade object
            const trade = {
                id: Date.now(),
                ticker: ticker,
                type: type,
                strike: strike,
                exp: exp,
                buyPrice: buyPrice,
                contracts: contracts,
                totalCost: totalCost,
                buyDate: new Date().toLocaleDateString(),
                buyTime: new Date().toLocaleTimeString(),
                status: 'active'
            };
            
            trades.push(trade);
            saveTrades(trades);
            
            alert('‚úÖ Trade tracked! Check "MY TRADES" section above to monitor it.');
            displayTrades();
            document.getElementById('tracker').style.display = 'block';
        }
        
        function getTrades() {
            const stored = localStorage.getItem('myTrades');
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveTrades(trades) {
            localStorage.setItem('myTrades', JSON.stringify(trades));
        }
        
        async function displayTrades() {
            const trades = getTrades();
            const activeTrades = trades.filter(t => t.status === 'active');
            
            if (activeTrades.length === 0) {
                document.getElementById('noTrades').style.display = 'block';
                document.getElementById('totalProfit').style.display = 'none';
                return;
            }
            
            document.getElementById('noTrades').style.display = 'none';
            
            let html = '';
            let totalProfit = 0;
            
            for (const trade of activeTrades) {
                // Get current price of the option
                const currentPrice = await getCurrentOptionPrice(trade.ticker, trade.type, trade.strike, trade.exp);
                const profit = currentPrice ? ((currentPrice - trade.buyPrice) * trade.contracts * 100) : 0;
                const profitPercent = trade.buyPrice > 0 ? ((currentPrice - trade.buyPrice) / trade.buyPrice * 100).toFixed(1) : '0.0';
                totalProfit += profit;
                
                const profitColor = profit >= 0 ? '#4ade80' : '#f87171';
                const arrow = trade.type === 'call' ? 'üìà' : 'üìâ';
                const shouldSell = profitPercent >= 50 || profitPercent <= -50; // Sell if +50% profit or -50% loss
                
                html += '<div class="trade-item ' + (shouldSell ? 'sell-now' : '') + '">';
                
                if (shouldSell) {
                    html += '<div style="background:#fbbf24;color:#000;padding:10px;border-radius:6px;margin-bottom:10px;font-weight:bold;text-align:center;font-size:1.2rem;">üö® SELL NOW! ' + (profit >= 0 ? 'TAKE PROFIT' : 'STOP LOSS') + '</div>';
                }
                
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">';
                html += '<h3 style="color:#fff;font-size:1.4rem;">' + arrow + ' ' + trade.ticker + ' $' + trade.strike + ' ' + trade.type.toUpperCase() + '</h3>';
                html += '<div style="font-size:1.5rem;font-weight:bold;color:' + profitColor + ';">' + (profit >= 0 ? '+' : '') + '$' + profit.toFixed(2) + '</div>';
                html += '</div>';
                
                html += '<div style="color:#94a3b8;margin-bottom:5px;">Bought: ' + trade.buyDate + ' at $' + trade.buyPrice.toFixed(2) + ' √ó ' + trade.contracts + ' contracts</div>';
                html += '<div style="color:#94a3b8;margin-bottom:5px;">Expires: ' + trade.exp + '</div>';
                html += '<div style="margin-bottom:10px;">Current Price: <span style="color:#4ade80;font-weight:bold;">$' + (currentPrice || trade.buyPrice).toFixed(2) + '</span> (<span style="color:' + profitColor + ';">' + (profitPercent >= 0 ? '+' : '') + profitPercent + '%</span>)</div>';
                
                html += '<div style="background:#0f172a;padding:12px;border-radius:6px;margin-bottom:10px;">';
                html += '<div style="color:#94a3b8;font-size:0.9rem;">Total Invested: $' + trade.totalCost.toFixed(2) + '</div>';
                html += '<div style="color:#94a3b8;font-size:0.9rem;">Current Value: <span style="color:#4ade80;">$' + ((currentPrice || trade.buyPrice) * trade.contracts * 100).toFixed(2) + '</span></div>';
                html += '</div>';
                
                // HOW TO SELL INSTRUCTIONS
                html += '<div style="background:#1e3a5f;padding:15px;border-radius:8px;margin-bottom:10px;">';
                html += '<h4 style="color:#38bdf8;margin-bottom:10px;font-size:1.1rem;">üì± How to Sell in Robinhood:</h4>';
                html += '<div style="color:#e0f2fe;line-height:1.8;font-size:0.95rem;">';
                html += '1. Open Robinhood ‚Üí Options ‚Üí Find this ' + trade.ticker + ' ' + trade.type + '<br>';
                html += '2. Tap on your contract ($' + trade.strike + ' expiring ' + trade.exp + ')<br>';
                html += '3. Tap "Trade" ‚Üí "Sell"<br>';
                html += '4. Enter ' + trade.contracts + ' contract' + (trade.contracts > 1 ? 's' : '') + '<br>';
                html += '5. Use LIMIT order at current price ($' + (currentPrice || trade.buyPrice).toFixed(2) + ') or better<br>';
                html += '6. Review ‚Üí "Sell" ‚Üí Get your money! üí∞';
                html += '</div></div>';
                
                html += '<button class="sell-button" onclick="markAsSold(' + trade.id + ')" style="width:100%;margin-top:10px;">‚úÖ I Sold This (Remove from List)</button>';
                html += '</div>';
            }
            
            document.getElementById('tradesList').innerHTML = html;
            
            // Show total profit
            document.getElementById('totalProfit').style.display = 'block';
            document.getElementById('totalProfitAmount').innerHTML = (totalProfit >= 0 ? '+' : '') + '$' + totalProfit.toFixed(2);
            document.getElementById('totalProfitAmount').style.color = totalProfit >= 0 ? '#4ade80' : '#f87171';
        }
        
        async function getCurrentOptionPrice(ticker, type, strike, exp) {
            // Simple estimation: fetch current stock price and estimate option value
            // In reality you'd need real-time option data, but this gives a rough idea
            try {
                const currentStockPrice = await getPrice(ticker);
                if (!currentStockPrice) return null;
                
                // Simple Black-Scholes approximation (very rough)
                const daysToExp = Math.max(1, Math.floor((new Date(exp) - new Date()) / (1000 * 60 * 60 * 24)));
                const intrinsicValue = type === 'call' ? Math.max(0, currentStockPrice - strike) : Math.max(0, strike - currentStockPrice);
                const timeValue = Math.sqrt(daysToExp / 30) * (currentStockPrice * 0.02); // Rough estimate
                
                return intrinsicValue + timeValue;
            } catch (e) {
                log('Error estimating option price: ' + e.message, 'error');
                return null;
            }
        }
        
        function markAsSold(tradeId) {
            if (!confirm('Did you really sell this? This will remove it from your active trades.')) return;
            
            const trades = getTrades();
            const index = trades.findIndex(t => t.id === tradeId);
            if (index !== -1) {
                trades[index].status = 'sold';
                trades[index].soldDate = new Date().toLocaleDateString();
                saveTrades(trades);
                displayTrades();
                alert('‚úÖ Trade marked as sold! Great job! üí∞');
            }
        }
        
        // Auto-refresh trades every 30 seconds
        setInterval(() => {
            const trades = getTrades().filter(t => t.status === 'active');
            if (trades.length > 0) {
                displayTrades();
            }
        }, 30000);
        
        // Load trades on page load
        window.addEventListener('load', () => {
            const trades = getTrades().filter(t => t.status === 'active');
            if (trades.length > 0) {
                document.getElementById('tracker').style.display = 'block';
                displayTrades();
            }
        });
    </script>
</body>

</html>